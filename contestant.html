<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تحدي 30 - المتسابق</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="header">
    <img src="https://uploads.onecompiler.io/43r6ub8mz/43r6u5fru/WhatsApp%20Image%202025-07-20%20at%2015.09.26_9c297a66.jpg" class="header-img" alt="شعار" />
    <h1>تحدي الثلاثين - المتسابق</h1>
  </div>

  <div class="quiz-container">
    <div id="questionBox" class="question-box">جاري تحميل السؤال...</div>
    <div id="optionsBox" class="options-box"></div>
    <div id="timer" class="timer-box">10</div>
    <div id="progress" class="progress-box"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC36UZNHXWDAU-ZghdNRUcRKSv2wAMXFos",
      authDomain: "quizmoath.firebaseapp.com",
      databaseURL: "https://quizmoath-default-rtdb.firebaseio.com",
      projectId: "quizmoath",
      storageBucket: "quizmoath.firebasestorage.app",
      messagingSenderId: "453820835054",
      appId: "1:453820835054:web:7d7fb622fa0984dee93fff",
      measurementId: "G-66C12P0D76"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    async function saveContestantResult(name, score) {
      try {
        const contestantsRef = ref(db, 'contestants');
        const newContestantRef = push(contestantsRef);
        await set(newContestantRef, {
          name: name,
          score: score,
          timestamp: Date.now()
        });
        console.log("تم حفظ نتيجة المتسابق بنجاح في Firebase");
      } catch (error) {
        console.error("خطأ أثناء حفظ النتيجة في Firebase:", error);
      }
    }

    // اللعبة والكود الأصلي مع التعديل
    let questions = shuffleArray(window.questions).slice(0, 10);

    let current = 0;
    let score = 0;
    let timer;
    let countdown = 10;

    const warningSound = new Audio("https://www.soundjay.com/button/sounds/beep-07.mp3");

    window.onload = () => {
      const lastScore = localStorage.getItem("lastScore");
      if (lastScore !== null) {
        alert(`علامتك من المرة السابقة: ${lastScore} من 10`);
      }
    };

    function startQuestion() {
      if (current >= questions.length) {
        showResult();
        return;
      }

      const q = questions[current];
      document.getElementById("questionBox").innerText = q.question;

      const optionsBox = document.getElementById("optionsBox");
      optionsBox.innerHTML = "";

      const shuffledOptions = shuffleArray([...q.answers]);

      shuffledOptions.forEach(opt => {
        const btn = document.createElement("button");
        btn.innerText = opt;
        btn.className = "option-btn";
        btn.onclick = () => {
          clearInterval(timer);
          if (opt === q.correct) score++;
          current++;
          startQuestion();
        };
        optionsBox.appendChild(btn);
      });

      countdown = 10;
      const timerEl = document.getElementById("timer");
      timerEl.innerText = countdown;
      timerEl.style.color = "#d35400";

      timer = setInterval(() => {
        countdown--;
        timerEl.innerText = countdown;

        if (countdown === 3) warningSound.play();
        if (countdown <= 3) timerEl.style.color = "red";
        else timerEl.style.color = "#d35400";

        if (countdown === 0) {
          clearInterval(timer);
          current++;
          startQuestion();
        }
      }, 1000);

      document.getElementById("progress").innerText = `السؤال ${current + 1} من ${questions.length}`;
    }

    async function showResult() {
      document.getElementById("questionBox").style.display = "none";
      document.getElementById("optionsBox").style.display = "none";
      document.getElementById("timer").style.display = "none";
      document.getElementById("progress").style.display = "none";

      const quizContainer = document.querySelector(".quiz-container");
      quizContainer.innerHTML = `
        <div class="result-box" style="font-size: 24px; color: #ff7700; text-align: center; margin-top: 40px;">
          انتهت الأسئلة! نتيجتك: ${score} من ${questions.length}
        </div>
      `;

      localStorage.setItem("lastScore", score);

      const contestant = JSON.parse(localStorage.getItem("currentContestant")) || { name: "المتسابق" };
      const playerName = contestant.name || "المتسابق";

      await saveContestantResult(playerName, score);

      setTimeout(() => {
        window.location.href = "index.html";
      }, 5000);
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    startQuestion();
  </script>

  <script src="questions.js"></script>
</body>
</html>
